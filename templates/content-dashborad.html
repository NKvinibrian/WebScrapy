<div class="d-flex dropdown-center mx-auto p-2 justify-content-center" style="width: 90%">
    <form class="d-flex form-inline my-2 my-lg-2 flex-row" style="width: 400px">
        <input id="search_field" class="form-control mr-4 mx-2" type="search" placeholder="Search" aria-label="Search">
    </form>
    <ul id="search_result" class="dropdown-menu mx-2 text-small shadow show" style="transform: translate(0px, 46px);"
        data-popper-placement="top-start">
        <li><a class="dropdown-item" href="#">Configuração</a></li>
        <li><a class="dropdown-item" href="/logoff">Sair</a></li>
    </ul>
</div>

<canvas class="my-4 px-4 w-100 chartjs-render-monitor" id="myChart" width="1500" height="633"
        style="display: block; width: 1500px; height: 633px;"></canvas>

<div class="table-responsive px-4">
    <table class="table table-striped table-sm">
        <thead>
        <tr>
            <th>ID</th>
            <th>Seller</th>
            <th>Ean</th>
            <th>Nome</th>
            <th>Valor</th>
            <th>Data</th>
        </tr>
        </thead>
        <tbody id="table-product">
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/feather-icons@4.9.0/dist/feather.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
        integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    let search = $("#search_field")
    let result = $("#search_result")
    let tableProduct = $("#table-product")

    listProduct = []
    result.hide()

    let typingTimer;
    let doneTypingInterval = 500; // Tempo em milissegundos (0.5 segundos)

    // Função para realizar a pesquisa
    function doSearch() {
        // Pega o valor digitado no campo de pesquisa
        let query = search.val();

        // Realiza a pesquisa somente se houver texto digitado
        if (query.trim() !== '') {
            // Aqui você pode realizar uma solicitação AJAX para o seu servidor para obter os resultados do banco de dados
            // Por enquanto, vamos apenas exibir a consulta digitada
            result.empty()
            searchAjax();
            result.show();
        } else {
            // Se o campo de pesquisa estiver vazio, limpe os resultados
            result.empty();
            result.hide();
        }
    }

    function searchAjax() {
        $.ajax({
            url: "{% url 'ajax_pesquisa' %}",
            type: "GET",
            data: {search: search.val()},
            success: function (response) {
                response.forEach(
                    data => result.append(`
                        <li class="search-item-result">
                            <a class="dropdown-item" >${data.ean} - ${data.name}</a>
                            <input type="hidden" value="${data.ean}">
                        </li>
                    `)
                );
                // evento de click
                $('.search-item-result').on('click', function () {
                    let ean = $(this).children('input').val();
                    getProductGraphAjax(ean)
                    result.hide();
                });
            }
        });
    }


    function getProductGraphAjax(ean){
        $.ajax({
            url: "{% url 'ajax_produto_graph' %}",
            type: "GET",
            data: {ean: ean},
            success: function (response) {
                listProduct.push(response);
                let fn = function(data){
                    tableProduct.append(`
                    <tr>
                        <td>${data.id}</td>
                        <td>${data.seller}</td>
                        <td>${data.ean}</td>
                        <td>${data.name}</td>
                        <td>${data.value}</td>
                        <td>${data.data_in}</td>
                    </tr>
                    `)
                }

                response['client'].forEach(fn);
                response['sellers'].forEach(fn);
            }
        })
    }


    $(document).ready(function () {

        // Evento de teclado
        search.keyup(function () {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(doSearch, doneTypingInterval);
        });

        // Evento para cancelar a pesquisa se o usuário começar a digitar novamente antes do tempo de espera
        search.keydown(function () {
            clearTimeout(typingTimer);
        });

        // Evento para fechar a pesquisa quando clicado fora
        $("main").click(function () {
            result.hide();
        });
    });

</script>


<script>
    (function () {
        'use strict'

        feather.replace()

        // Graphs
        var ctx = document.getElementById('myChart')
        // eslint-disable-next-line no-unused-vars
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [
                    'Sunday',
                    'Monday',
                    'Tuesday',
                    'Wednesday',
                    'Thursday',
                    'Friday',
                    'Saturday'
                ],
                datasets: [{
                    data: [
                        15339,
                        21345,
                        18483,
                        24003,
                        23489,
                        24092,
                        12034
                    ],
                    lineTension: 0,
                    backgroundColor: 'transparent',
                    borderColor: '#007bff',
                    borderWidth: 4,
                    pointBackgroundColor: '#007bff'
                },
                    {
                        data: [
                            12339,
                            22345,
                            13483,
                            21003,
                            20489,
                            27092,
                            32034
                        ],
                        lineTension: 0,
                        backgroundColor: 'transparent',
                        borderColor: '#7b00ff',
                        borderWidth: 4,
                        pointBackgroundColor: '#7b00ff'
                    }
                ]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: false
                        }
                    }]
                },
                legend: {
                    display: false
                }
            }
        })
    }())

</script>